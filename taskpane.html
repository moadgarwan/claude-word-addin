<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GPT for Word</title>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --accent: #10A37F; --accent-hover: #0D8C6D; --bg: #FAF9F7; --text: #1A1A1A;
      --text-secondary: #6B6560; --border: #E8E5E0;
      --user-bg: #F0EFEB; --assistant-bg: #FFFFFF; --hover: #EEEDEA;
    }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; font-size: 13px; line-height: 1.5; }

    /* ── Setup Screen ── */
    #setup-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 24px; text-align: center; }
    #setup-screen .logo { width: 48px; height: 48px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    #setup-screen .logo svg { width: 28px; height: 28px; }
    #setup-screen h1 { font-size: 18px; font-weight: 600; margin-bottom: 6px; }
    #setup-screen p { color: var(--text-secondary); font-size: 12.5px; margin-bottom: 20px; max-width: 260px; }
    #setup-screen input { width: 100%; max-width: 300px; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 13px; outline: none; }
    #setup-screen input:focus { border-color: var(--accent); }
    #setup-screen .btn-primary { margin-top: 12px; width: 100%; max-width: 300px; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 8px; font-size: 13px; font-weight: 500; cursor: pointer; }
    #setup-screen .hint { margin-top: 12px; font-size: 11px; color: var(--text-secondary); }
    #setup-screen .hint a { color: var(--accent); text-decoration: none; }

    /* ── Mode Select Screen ── */
    #mode-screen { display: none; flex-direction: column; align-items: center; justify-content: center; height: 100vh; padding: 24px; text-align: center; }
    #mode-screen .logo { width: 48px; height: 48px; background: var(--accent); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    #mode-screen .logo svg { width: 28px; height: 28px; }
    #mode-screen h1 { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
    #mode-screen .subtitle { color: var(--text-secondary); font-size: 12.5px; margin-bottom: 24px; }

    .mode-cards { display: flex; flex-direction: column; gap: 12px; width: 100%; max-width: 300px; }
    .mode-card {
      border: 2px solid var(--border); border-radius: 12px; padding: 16px;
      cursor: pointer; text-align: left; background: var(--assistant-bg);
      transition: all 0.2s ease;
    }
    .mode-card:hover { border-color: var(--accent); background: #F0FDF8; }
    .mode-card.active { border-color: var(--accent); background: #F0FDF8; }
    .mode-card .mode-icon { font-size: 24px; margin-bottom: 8px; }
    .mode-card .mode-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; color: var(--text); }
    .mode-card .mode-desc { font-size: 11.5px; color: var(--text-secondary); line-height: 1.4; }

    /* ── Header ── */
    .header { display: flex; align-items: center; gap: 10px; padding: 12px 16px; border-bottom: 1px solid var(--border); background: var(--assistant-bg); flex-shrink: 0; }
    .header .logo-small { width: 28px; height: 28px; background: var(--accent); border-radius: 7px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .header .logo-small svg { width: 16px; height: 16px; }
    .header .title { font-weight: 600; font-size: 14px; flex: 1; }
    .header .mode-badge { font-size: 10px; font-weight: 600; padding: 2px 8px; border-radius: 10px; background: #ECFDF5; color: var(--accent); border: 1px solid #A7F3D0; }
    .header .actions { display: flex; gap: 4px; }
    .header .actions button { background: none; border: none; padding: 4px 6px; border-radius: 6px; cursor: pointer; color: var(--text-secondary); font-size: 12px; }
    .header .actions button:hover { background: var(--hover); }

    /* ── Chat ── */
    #chat-screen { display: none; flex-direction: column; height: 100vh; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 16px; }
    .message { display: flex; gap: 10px; }
    .message .avatar { width: 24px; height: 24px; border-radius: 6px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; margin-top: 2px; }
    .message.user .avatar { background: var(--user-bg); color: var(--text-secondary); }
    .message.assistant .avatar { background: var(--accent); color: white; }
    .message .content { flex: 1; min-width: 0; }
    .message .sender { font-size: 12px; font-weight: 600; margin-bottom: 3px; }
    .message .text { font-size: 13px; line-height: 1.55; word-wrap: break-word; white-space: pre-wrap; }
    .message .text code { background: var(--hover); padding: 1px 5px; border-radius: 4px; font-size: 12px; }
    .message .text pre { background: #2D2D2D; color: #E6E6E6; padding: 12px; border-radius: 8px; overflow-x: auto; margin: 8px 0; font-size: 12px; }

    .message-actions { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .message-actions button { padding: 5px 10px; border: 1px solid var(--border); background: var(--assistant-bg); border-radius: 6px; font-size: 11.5px; cursor: pointer; color: var(--text-secondary); }
    .message-actions button:hover { border-color: var(--accent); color: var(--accent); }
    .message-actions button.primary-action { border-color: var(--accent); background: var(--accent); color: white; }
    .message-actions button.primary-action:hover { opacity: 0.9; }

    .changes-preview { margin-top: 8px; border: 1px solid var(--border); border-radius: 8px; overflow: hidden; font-size: 12px; }
    .changes-preview .changes-header { background: var(--hover); padding: 6px 10px; font-weight: 600; font-size: 11.5px; color: var(--text-secondary); border-bottom: 1px solid var(--border); }
    .change-item { padding: 8px 10px; border-bottom: 1px solid var(--border); }
    .change-item:last-child { border-bottom: none; }
    .change-item .change-old { background: #FEE2E2; color: #991B1B; padding: 2px 4px; border-radius: 3px; text-decoration: line-through; }
    .change-item .change-new { background: #DCFCE7; color: #166534; padding: 2px 4px; border-radius: 3px; }
    .change-item .change-arrow { color: var(--text-secondary); margin: 0 4px; }

    .status-msg { padding: 8px 12px; border-radius: 8px; font-size: 12px; margin-top: 4px; }
    .status-msg.success { background: #F0FDF4; border: 1px solid #BBF7D0; color: #166534; }
    .status-msg.error { background: #FEF2F2; border: 1px solid #FECACA; color: #B91C1C; }
    .status-msg.info { background: #EFF6FF; border: 1px solid #BFDBFE; color: #1E40AF; }

    .typing-indicator { display: none; gap: 10px; }
    .typing-indicator.visible { display: flex; }
    .typing-dots { display: flex; gap: 4px; align-items: center; padding-top: 4px; }
    .typing-dots span { width: 6px; height: 6px; background: var(--text-secondary); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; opacity: 0.4; }
    .typing-dots span:nth-child(1) { animation-delay: 0s; }
    .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
    .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes bounce { 0%,80%,100% { transform: scale(0.8); opacity: 0.4; } 40% { transform: scale(1.2); opacity: 1; } }

    .quick-actions { display: flex; flex-wrap: wrap; gap: 6px; padding: 0 16px 8px; flex-shrink: 0; }
    .quick-actions button { padding: 6px 12px; border: 1px solid var(--border); background: var(--assistant-bg); border-radius: 16px; font-size: 11.5px; cursor: pointer; color: var(--text-secondary); white-space: nowrap; }
    .quick-actions button:hover { border-color: var(--accent); color: var(--accent); }

    .input-area { padding: 12px 16px 16px; border-top: 1px solid var(--border); background: var(--assistant-bg); flex-shrink: 0; }
    .input-wrapper { display: flex; gap: 8px; align-items: flex-end; }
    .input-wrapper textarea { flex: 1; padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 10px; font-size: 13px; font-family: inherit; resize: none; outline: none; min-height: 40px; max-height: 120px; background: var(--bg); line-height: 1.4; }
    .input-wrapper textarea:focus { border-color: var(--accent); }
    .input-wrapper .send-btn { width: 36px; height: 36px; background: var(--accent); border: none; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .input-wrapper .send-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .input-wrapper .send-btn svg { width: 16px; height: 16px; fill: white; }
    .input-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 6px; padding: 0 2px; }
    .input-footer .context-toggle { display: flex; align-items: center; gap: 5px; font-size: 11px; color: var(--text-secondary); cursor: pointer; }
    .input-footer .context-toggle input[type="checkbox"] { accent-color: var(--accent); }
    .input-footer .model-info { font-size: 10.5px; color: var(--text-secondary); }

    .chat-messages::-webkit-scrollbar { width: 5px; }
    .chat-messages::-webkit-scrollbar-track { background: transparent; }
    .chat-messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }

    .welcome { text-align: center; padding: 32px 16px; color: var(--text-secondary); }
    .welcome .logo-large { width: 44px; height: 44px; background: var(--accent); border-radius: 11px; display: flex; align-items: center; justify-content: center; margin: 0 auto 12px; }
    .welcome .logo-large svg { width: 24px; height: 24px; }
    .welcome h2 { font-size: 16px; font-weight: 600; color: var(--text); margin-bottom: 6px; }
    .welcome p { font-size: 12.5px; }
  </style>
</head>
<body>

  <!-- ════════ SCREEN 1: API Key ════════ -->
  <div id="setup-screen">
    <div class="logo"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-1-1 4-4-4-4 1-1 5 5-5 5z" fill="white"/></svg></div>
    <h1>GPT for Word</h1>
    <p>Enter your OpenAI API key to start chatting with GPT about your documents.</p>
    <input type="password" id="api-key-input" placeholder="sk-proj-..." />
    <button class="btn-primary" onclick="saveApiKey()">Get Started</button>
    <p class="hint">Get your API key at <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com</a></p>
  </div>

  <!-- ════════ SCREEN 2: Mode Selection ════════ -->
  <div id="mode-screen">
    <div class="logo"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-1-1 4-4-4-4 1-1 5 5-5 5z" fill="white"/></svg></div>
    <h1>Choose a Mode</h1>
    <p class="subtitle">How would you like GPT to work with your document?</p>
    <div class="mode-cards">
      <div class="mode-card" onclick="selectMode('rewriter')">
        <div class="mode-icon">&#9997;&#65039;</div>
        <div class="mode-title">Full Rewriter</div>
        <div class="mode-desc">GPT rewrites your entire document based on your instructions. The full text is replaced with a new version.</div>
      </div>
      <div class="mode-card" onclick="selectMode('editor')">
        <div class="mode-icon">&#128269;</div>
        <div class="mode-title">Editor</div>
        <div class="mode-desc">GPT makes targeted edits — fix grammar, improve phrases, translate words. Changes are applied one by one with preview.</div>
      </div>
    </div>
  </div>

  <!-- ════════ SCREEN 3: Chat ════════ -->
  <div id="chat-screen">
    <div class="header">
      <div class="logo-small"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-1-1 4-4-4-4 1-1 5 5-5 5z" fill="white"/></svg></div>
      <span class="title">GPT for Word</span>
      <span class="mode-badge" id="mode-badge">EDITOR</span>
      <div class="actions">
        <button onclick="switchMode()" title="Switch mode">Mode</button>
        <button onclick="newChat()">New</button>
        <button onclick="showSettings()">&#9881;</button>
      </div>
    </div>

    <div class="chat-messages" id="chat-messages">
      <div class="welcome" id="welcome-msg">
        <div class="logo-large"><svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 15l-1-1 4-4-4-4 1-1 5 5-5 5z" fill="white"/></svg></div>
        <h2 id="welcome-title">How can I help?</h2>
        <p id="welcome-desc">I can read and directly edit your document.</p>
      </div>
      <div class="typing-indicator message assistant" id="typing-indicator">
        <div class="avatar">G</div>
        <div class="content"><div class="typing-dots"><span></span><span></span><span></span></div></div>
      </div>
    </div>

    <div class="quick-actions" id="quick-actions"></div>

    <div class="input-area">
      <div class="input-wrapper">
        <textarea id="user-input" placeholder="Describe what you want..." rows="1" onkeydown="handleKeyDown(event)" oninput="autoResize(this)"></textarea>
        <button class="send-btn" id="send-btn" onclick="sendMessage()"><svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg></button>
      </div>
      <div class="input-footer">
        <label class="context-toggle"><input type="checkbox" id="include-doc" checked /> Include document</label>
        <span class="model-info">GPT-5.2</span>
      </div>
    </div>
  </div>

  <script>
    let API_KEY = '', conversationHistory = [], isProcessing = false, officeReady = false;
    let currentMode = 'editor'; // 'editor' or 'rewriter'

    /* ── System Prompts ── */
    const EDITOR_PROMPT = `You are GPT, an AI assistant in Microsoft Word. You make targeted edits to documents.

When asked to edit/fix/improve/translate text, respond with JSON changes:

\`\`\`json-changes
{
  "changes": [
    {"find": "exact text from doc", "replace": "corrected text"}
  ],
  "summary": "What was changed"
}
\`\`\`

CRITICAL RULES FOR "find" VALUES:
1. Copy the EXACT text from the document content I provide — character for character
2. Keep each "find" SHORT: target only the specific wrong word(s) plus 2-3 surrounding words for uniqueness (ideally 10-40 characters)
3. Each "find" must be unique in the document
4. One fix per change entry — don't combine multiple errors
5. For Arabic text: copy exact characters from the provided document text, never retype
6. DO NOT include line breaks or paragraph breaks in "find" values
7. If a word appears multiple times, include the minimum surrounding context to make it unique

GOOD example:
{"find": "teh quick brown", "replace": "the quick brown"}

BAD example (too long):
{"find": "The quick brown fox jumped over the lazy dog and then ran away into the forest", "replace": "..."}

For questions (summarize, explain) without editing, respond normally without JSON.`;

    const REWRITER_PROMPT = `You are GPT, an AI assistant in Microsoft Word. You rewrite entire documents based on user instructions.

The user will provide the current document content and describe how they want it rewritten. Your job is to return the COMPLETE rewritten document text.

RULES:
1. Return ONLY the rewritten document text — no explanations, no commentary before or after
2. Rewrite the ENTIRE document according to the user's instructions
3. Maintain the document's structure (paragraphs, sections) unless told otherwise
4. If the user asks to change tone, style, language, format, etc., apply it to the whole document
5. Do NOT wrap your response in code blocks or quotes — just return the plain rewritten text
6. Preserve any formatting cues like headings or bullet points in plain text form
7. If the user asks a question instead of requesting a rewrite, answer normally

The user's rewritten document will replace the entire original document.`;

    Office.onReady(function() {
      officeReady = true;
      const k = localStorage.getItem('openai_api_key');
      if (k) {
        API_KEY = k;
        showModeScreen();
      }
    });

    /* ── Navigation ── */
    function saveApiKey() {
      const k = document.getElementById('api-key-input').value.trim();
      if (!k) return;
      API_KEY = k;
      localStorage.setItem('openai_api_key', k);
      showModeScreen();
    }

    function showModeScreen() {
      document.getElementById('setup-screen').style.display = 'none';
      document.getElementById('mode-screen').style.display = 'flex';
      document.getElementById('chat-screen').style.display = 'none';
    }

    function selectMode(mode) {
      currentMode = mode;
      document.getElementById('mode-screen').style.display = 'none';
      document.getElementById('chat-screen').style.display = 'flex';
      applyModeUI();
      document.getElementById('user-input').focus();
    }

    function switchMode() {
      conversationHistory = [];
      showModeScreen();
    }

    function applyModeUI() {
      const badge = document.getElementById('mode-badge');
      const welcomeTitle = document.getElementById('welcome-title');
      const welcomeDesc = document.getElementById('welcome-desc');
      const input = document.getElementById('user-input');
      const qa = document.getElementById('quick-actions');

      if (currentMode === 'rewriter') {
        badge.textContent = 'REWRITER';
        badge.style.background = '#FEF3C7';
        badge.style.color = '#D97706';
        badge.style.borderColor = '#FCD34D';
        welcomeTitle.textContent = 'Full Rewriter';
        welcomeDesc.textContent = 'Describe how you want your document rewritten. The entire text will be replaced with a new version.';
        input.placeholder = 'Describe how to rewrite the document...';
        qa.innerHTML = '';
        const btns = [
          ['Make it more formal', 'Rewrite in a formal professional tone'],
          ['Simplify language', 'Rewrite using simpler, clearer language'],
          ['Translate to English', 'Translate the entire document to English'],
          ['Make it shorter', 'Rewrite to be more concise, keeping key points']
        ];
        btns.forEach(([label, action]) => {
          const b = document.createElement('button');
          b.textContent = label;
          b.onclick = () => quickAction(action);
          qa.appendChild(b);
        });
      } else {
        badge.textContent = 'EDITOR';
        badge.style.background = '#ECFDF5';
        badge.style.color = '#10A37F';
        badge.style.borderColor = '#A7F3D0';
        welcomeTitle.textContent = 'How can I help?';
        welcomeDesc.textContent = 'I can fix grammar, improve style, translate phrases, and make targeted edits to your document.';
        input.placeholder = 'Ask GPT to edit your document...';
        qa.innerHTML = '';
        const btns = [
          ['Fix Grammar', 'Fix grammar and spelling'],
          ['Improve Style', 'Improve writing style'],
          ['Translate to French', 'Translate to French'],
          ['Summarize', 'Summarize']
        ];
        btns.forEach(([label, action]) => {
          const b = document.createElement('button');
          b.textContent = label;
          b.onclick = () => quickAction(action);
          qa.appendChild(b);
        });
      }
      qa.style.display = 'flex';
    }

    function showSettings() { const k = prompt('Enter OpenAI API key:'); if (k) { API_KEY = k.trim(); localStorage.setItem('openai_api_key', API_KEY); } }

    /* ── Document Operations ── */
    async function getDocumentContent() {
      if (!officeReady) return '';
      return new Promise(r => {
        Word.run(async ctx => { const b = ctx.document.body; b.load('text'); await ctx.sync(); r(b.text || ''); }).catch(() => r(''));
      });
    }

    async function getSelectedText() {
      if (!officeReady) return '';
      return new Promise(r => {
        Word.run(async ctx => { const s = ctx.document.getSelection(); s.load('text'); await ctx.sync(); r(s.text || ''); }).catch(() => r(''));
      });
    }

    async function replaceTextInDocument(findText, replaceText) {
      if (!officeReady) return false;
      return new Promise(resolve => {
        Word.run(async ctx => {
          try { ctx.document.load('changeTrackingMode'); await ctx.sync(); ctx.document.changeTrackingMode = Word.ChangeTrackingMode.trackAll; await ctx.sync(); } catch(e) {}
          const body = ctx.document.body;

          // Strategy 1: Exact match
          let sr = body.search(findText, { matchCase: true, matchWholeWord: false });
          sr.load('items'); await ctx.sync();
          if (sr.items.length > 0) { sr.items[0].insertText(replaceText, Word.InsertLocation.replace); await ctx.sync(); resolve(true); return; }

          // Strategy 2: Case insensitive
          sr = body.search(findText, { matchCase: false, matchWholeWord: false });
          sr.load('items'); await ctx.sync();
          if (sr.items.length > 0) { sr.items[0].insertText(replaceText, Word.InsertLocation.replace); await ctx.sync(); resolve(true); return; }

          // Strategy 3: Trimmed
          const t = findText.trim();
          if (t !== findText) {
            sr = body.search(t, { matchCase: false }); sr.load('items'); await ctx.sync();
            if (sr.items.length > 0) { sr.items[0].insertText(replaceText, Word.InsertLocation.replace); await ctx.sync(); resolve(true); return; }
          }

          // Strategy 4: Paragraph-level
          try {
            const paragraphs = body.paragraphs;
            paragraphs.load('items'); await ctx.sync();
            for (let i = 0; i < paragraphs.items.length; i++) {
              const p = paragraphs.items[i];
              p.load('text'); await ctx.sync();
              if (p.text && p.text.includes(findText)) {
                const newText = p.text.replace(findText, replaceText);
                p.insertText(newText, Word.InsertLocation.replace);
                await ctx.sync(); resolve(true); return;
              }
            }
          } catch(e) {}

          // Strategy 5: Normalized whitespace
          try {
            const paragraphs = body.paragraphs;
            paragraphs.load('items'); await ctx.sync();
            const nf = findText.replace(/\s+/g, ' ').trim();
            for (let i = 0; i < paragraphs.items.length; i++) {
              const p = paragraphs.items[i];
              p.load('text'); await ctx.sync();
              if (p.text) {
                const np = p.text.replace(/\s+/g, ' ').trim();
                if (np.includes(nf)) {
                  const idx = np.indexOf(nf);
                  p.insertText(np.substring(0, idx) + replaceText + np.substring(idx + nf.length), Word.InsertLocation.replace);
                  await ctx.sync(); resolve(true); return;
                }
              }
            }
          } catch(e) {}

          resolve(false);
        }).catch(() => resolve(false));
      });
    }

    async function applyChangesToDocument(changes) {
      let applied = 0, failed = 0, failedItems = [];
      for (const c of changes) {
        if (await replaceTextInDocument(c.find, c.replace)) { applied++; }
        else { failed++; failedItems.push(c.find.substring(0, 40)); }
      }
      return { applied, failed, failedItems };
    }

    async function replaceFullDocument(newContent) {
      if (!officeReady) return false;
      return new Promise(r => {
        Word.run(async ctx => {
          try { ctx.document.load('changeTrackingMode'); await ctx.sync(); ctx.document.changeTrackingMode = Word.ChangeTrackingMode.trackAll; await ctx.sync(); } catch(e) {}
          ctx.document.body.clear();
          ctx.document.body.insertText(newContent, Word.InsertLocation.start);
          await ctx.sync(); r(true);
        }).catch(() => r(false));
      });
    }

    /* ── Parse ── */
    function parseChanges(text) {
      const m = text.match(/```json-changes\s*\n([\s\S]*?)\n```/);
      if (!m) return null;
      try { const p = JSON.parse(m[1]); if (p.changes && Array.isArray(p.changes)) return p; } catch(e) {}
      return null;
    }
    function stripChangesBlock(text) { return text.replace(/```json-changes\s*\n[\s\S]*?\n```/, '').trim(); }

    /* ── Chat ── */
    function handleKeyDown(e) { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } }
    function autoResize(el) { el.style.height = 'auto'; el.style.height = Math.min(el.scrollHeight, 120) + 'px'; }
    function quickAction(t) { document.getElementById('user-input').value = t; sendMessage(); }

    function newChat() {
      conversationHistory = [];
      const m = document.getElementById('chat-messages'), w = m.querySelector('.welcome'), t = document.getElementById('typing-indicator');
      m.innerHTML = ''; if (w) { m.appendChild(w); w.style.display = 'block'; } m.appendChild(t);
      applyModeUI();
    }

    async function sendMessage() {
      const input = document.getElementById('user-input'), text = input.value.trim();
      if (!text || isProcessing) return;
      isProcessing = true; input.value = ''; autoResize(input);
      document.getElementById('send-btn').disabled = true;

      const w = document.querySelector('.welcome'); if (w) w.style.display = 'none';
      document.getElementById('quick-actions').style.display = 'none';

      let doc = '', sel = await getSelectedText();
      if (document.getElementById('include-doc').checked) doc = await getDocumentContent();

      let full = text;
      if (sel) full = `[Selected text]: "${sel}"\n\n${text}`;
      if (doc) full = `[Document content]:\n${doc}\n\n---\n\n${full}`;

      addMessageToUI('user', text);
      conversationHistory.push({ role: 'user', content: full });
      showTyping(true);

      try {
        const resp = await callAPI();
        showTyping(false);

        if (currentMode === 'rewriter') {
          // Rewriter mode: show the rewritten text with a Replace button
          addRewriterMessageToUI(resp);
        } else {
          // Editor mode: parse JSON changes or show plain text
          const changes = parseChanges(resp);
          if (changes) { addChangesUI(changes, stripChangesBlock(resp), resp); }
          else { addMessageToUI('assistant', resp, true); }
        }

        conversationHistory.push({ role: 'assistant', content: resp });
      } catch(err) {
        showTyping(false);
        addStatus('error', err.message || 'Something went wrong.');
      }

      isProcessing = false; document.getElementById('send-btn').disabled = false; input.focus();
    }

    async function callAPI() {
      const systemPrompt = currentMode === 'rewriter' ? REWRITER_PROMPT : EDITOR_PROMPT;
      const messages = [
        { role: 'system', content: systemPrompt },
        ...conversationHistory
      ];

      const r = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': 'Bearer ' + API_KEY
        },
        body: JSON.stringify({
          model: 'gpt-5.2',
          messages: messages,
          max_completion_tokens: 16384
        })
      });

      if (!r.ok) {
        const e = await r.json().catch(() => ({}));
        if (r.status === 401) throw new Error('Invalid API key. Check settings.');
        if (r.status === 429) throw new Error('Rate limit exceeded. Please wait.');
        if (r.status === 402) throw new Error('Insufficient credits. Add billing at platform.openai.com.');
        throw new Error(e.error?.message || `API error (${r.status})`);
      }

      const d = await r.json();
      return d.choices[0].message.content;
    }

    /* ── UI ── */
    function addMessageToUI(role, text, actions = false) {
      const c = document.getElementById('chat-messages'), t = document.getElementById('typing-indicator');
      const msg = document.createElement('div'); msg.className = `message ${role}`;
      msg.innerHTML = `<div class="avatar">${role === 'user' ? 'M' : 'G'}</div>
        <div class="content"><div class="sender">${role === 'user' ? 'You' : 'GPT'}</div><div class="text">${formatMD(text)}</div>
        ${actions && role === 'assistant' ? '<div class="message-actions"></div>' : ''}</div>`;
      c.insertBefore(msg, t);
      if (actions && role === 'assistant') {
        const ad = msg.querySelector('.message-actions');
        const cb = document.createElement('button'); cb.textContent = 'Copy';
        cb.onclick = () => { navigator.clipboard.writeText(text); cb.textContent = 'Copied!'; setTimeout(() => cb.textContent = 'Copy', 1500); };
        ad.appendChild(cb);
      }
      c.scrollTop = c.scrollHeight;
    }

    function addRewriterMessageToUI(text) {
      const c = document.getElementById('chat-messages'), t = document.getElementById('typing-indicator');
      const msg = document.createElement('div'); msg.className = 'message assistant';

      // Show a truncated preview
      const preview = text.length > 300 ? text.substring(0, 300) + '...' : text;

      msg.innerHTML = `<div class="avatar">G</div><div class="content">
        <div class="sender">GPT</div>
        <div class="text" style="background: #F0FDF4; border: 1px solid #BBF7D0; padding: 10px; border-radius: 8px; font-size: 12px; max-height: 200px; overflow-y: auto;">${esc(preview)}</div>
        <div style="font-size: 11px; color: var(--text-secondary); margin-top: 4px;">${text.length} characters — full rewrite ready</div>
        <div class="message-actions"></div>
      </div>`;

      c.insertBefore(msg, t);

      const ad = msg.querySelector('.message-actions');

      const rb = document.createElement('button');
      rb.className = 'primary-action';
      rb.textContent = 'Replace Document';
      rb.onclick = async () => {
        rb.textContent = 'Replacing...'; rb.disabled = true;
        const ok = await replaceFullDocument(text);
        rb.textContent = ok ? 'Replaced!' : 'Failed';
        if (ok) addStatus('success', 'Document replaced with rewritten version. Use Track Changes to review.');
        else addStatus('error', 'Failed to replace document.');
      };
      ad.appendChild(rb);

      const cb = document.createElement('button');
      cb.textContent = 'Copy';
      cb.onclick = () => { navigator.clipboard.writeText(text); cb.textContent = 'Copied!'; setTimeout(() => cb.textContent = 'Copy', 1500); };
      ad.appendChild(cb);

      const eb = document.createElement('button');
      eb.textContent = 'Show Full Text';
      eb.onclick = () => {
        const textDiv = msg.querySelector('.text');
        if (eb.textContent === 'Show Full Text') {
          textDiv.textContent = text;
          textDiv.style.maxHeight = '400px';
          eb.textContent = 'Show Less';
        } else {
          textDiv.textContent = preview;
          textDiv.style.maxHeight = '200px';
          eb.textContent = 'Show Full Text';
        }
      };
      ad.appendChild(eb);

      c.scrollTop = c.scrollHeight;
    }

    function addChangesUI(data, explanation, full) {
      const c = document.getElementById('chat-messages'), t = document.getElementById('typing-indicator');
      const msg = document.createElement('div'); msg.className = 'message assistant';

      let html = data.changes.map(ch => {
        const f = esc(ch.find.length > 60 ? ch.find.substring(0,60)+'...' : ch.find);
        const r = esc(ch.replace.length > 60 ? ch.replace.substring(0,60)+'...' : ch.replace);
        return `<div class="change-item"><span class="change-old">${f}</span><span class="change-arrow"> → </span><span class="change-new">${r}</span></div>`;
      }).join('');

      msg.innerHTML = `<div class="avatar">G</div><div class="content">
        <div class="sender">GPT</div>
        ${data.summary ? `<div class="text">${esc(data.summary)}</div>` : ''}
        <div class="changes-preview"><div class="changes-header">${data.changes.length} change${data.changes.length>1?'s':''}</div>${html}</div>
        <div class="message-actions"></div>
        ${explanation ? `<div class="text" style="margin-top:8px">${formatMD(explanation)}</div>` : ''}
      </div>`;

      c.insertBefore(msg, t);

      const ad = msg.querySelector('.message-actions');
      const ab = document.createElement('button'); ab.className = 'primary-action'; ab.textContent = 'Apply Changes';
      ab.onclick = async () => {
        ab.textContent = 'Applying...'; ab.disabled = true;
        const res = await applyChangesToDocument(data.changes);
        if (res.applied > 0 && res.failed === 0) addStatus('success', `All ${res.applied} change${res.applied>1?'s':''} applied!`);
        else if (res.applied > 0) addStatus('info', `Applied ${res.applied}, ${res.failed} failed: ${res.failedItems.join(', ')}`);
        else addStatus('error', 'Could not match text. Try selecting text first or ask GPT to retry.');
        ab.textContent = res.applied > 0 ? 'Applied' : 'Failed';
      };
      ad.appendChild(ab);

      const cb = document.createElement('button'); cb.textContent = 'Copy';
      cb.onclick = () => { navigator.clipboard.writeText(full); cb.textContent = 'Copied!'; setTimeout(() => cb.textContent = 'Copy', 1500); };
      ad.appendChild(cb);

      c.scrollTop = c.scrollHeight;
    }

    function addStatus(type, msg) {
      const c = document.getElementById('chat-messages'), t = document.getElementById('typing-indicator');
      const d = document.createElement('div'); d.className = `status-msg ${type}`; d.textContent = msg;
      c.insertBefore(d, t); c.scrollTop = c.scrollHeight;
    }

    function showTyping(s) { document.getElementById('typing-indicator').classList.toggle('visible', s); if (s) document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight; }

    function formatMD(t) {
      let h = esc(t);
      h = h.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>');
      h = h.replace(/`([^`]+)`/g, '<code>$1</code>');
      h = h.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');
      h = h.replace(/\*([^*]+)\*/g, '<em>$1</em>');
      h = h.replace(/\n/g, '<br>');
      return h;
    }

    function esc(t) { const d = document.createElement('div'); d.textContent = t; return d.innerHTML; }
  </script>
</body>
</html>
